<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raporlar - Fırın Pastane Admin</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="admin-panel">
    <header class="admin-header">
        <nav class="admin-nav">
            <div class="nav-logo">
                <i class="fas fa-bread-slice"></i>
                <span>Fırın Pastane Admin</span>
            </div>
            <div class="admin-nav-right">
                <button id="sidebarToggle" class="btn btn-outline">
                    <i class="fas fa-bars"></i>
                </button>
                <span class="admin-user">Admin User</span>
                <button id="logoutBtn" class="btn btn-outline">
                    <i class="fas fa-sign-out-alt"></i> Çıkış
                </button>
            </div>
        </nav>
    </header>

    <div class="admin-layout">
        <aside class="admin-sidebar">
            <nav>
                <ul>
                    <li>
                        <a href="dashboard.html">
                            <i class="fas fa-tachometer-alt"></i>
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="urunler.html">
                            <i class="fas fa-boxes"></i>
                            Ürün Yönetimi
                        </a>
                    </li>
                    <li>
                        <a href="siparisler.html">
                            <i class="fas fa-shopping-cart"></i>
                            Sipariş Yönetimi
                        </a>
                    </li>
                    <li>
                        <a href="musteriler.html">
                            <i class="fas fa-users"></i>
                            Müşteri Yönetimi
                        </a>
                    </li>
                    <li>
                        <a href="raporlar.html" class="active">
                            <i class="fas fa-chart-bar"></i>
                            Raporlar
                        </a>
                    </li>
                    <li>
                        <hr style="border-color: var(--border-light); margin: 1rem 0;">
                    </li>
                    <li>
                        <a href="../index.html">
                            <i class="fas fa-home"></i>
                            Ana Siteye Dön
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="admin-content">
            <div class="breadcrumb">
                <span class="breadcrumb-item">Admin</span>
                <span class="breadcrumb-item">Raporlar</span>
            </div>

            <div class="page-header">
                <h1>Raporlar ve Analizler</h1>
                <div class="report-filters" style="display: flex; gap: 1rem; align-items: center;">
                    <select id="reportPeriod" style="padding: 0.5rem; border: 1px solid var(--border-light); border-radius: 5px;">
                        <option value="today">Bugün</option>
                        <option value="week">Bu Hafta</option>
                        <option value="month" selected>Bu Ay</option>
                        <option value="year">Bu Yıl</option>
                    </select>
                    <button id="refreshReports" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i>
                        Yenile
                    </button>
                </div>
            </div>

            <!-- Sales Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-lira-sign" style="color: var(--primary-brown);"></i>
                    </div>
                    <div class="stat-number" id="period-revenue">0 TL</div>
                    <div class="stat-label">Dönem Geliri</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-shopping-cart" style="color: var(--secondary-gold);"></i>
                    </div>
                    <div class="stat-number" id="period-orders">0</div>
                    <div class="stat-label">Dönem Siparişi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line" style="color: var(--accent-orange);"></i>
                    </div>
                    <div class="stat-number" id="average-order">0 TL</div>
                    <div class="stat-label">Ortalama Sipariş</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-boxes" style="color: #28a745;"></i>
                    </div>
                    <div class="stat-number" id="total-products-sold">0</div>
                    <div class="stat-label">Satılan Ürün</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <!-- Best Selling Products -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">En Çok Satan Ürünler</h2>
                    </div>
                    <div id="bestSellingProducts">
                        <!-- Best selling products will be loaded here -->
                    </div>
                </div>

                <!-- Revenue by Category -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Kategori Bazında Gelir</h2>
                    </div>
                    <div id="revenueByCategory">
                        <!-- Revenue by category will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Sales Chart (Simple representation) -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Satış Trendi</h2>
                </div>
                <div id="salesChart" style="padding: 2rem;">
                    <div class="chart-container" style="display: flex; align-items: end; gap: 1rem; height: 200px; justify-content: space-around;">
                        <!-- Simple bar chart will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Detailed Reports -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <!-- Stock Report -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Stok Durumu Raporu</h2>
                    </div>
                    <div id="stockReport">
                        <!-- Stock report will be loaded here -->
                    </div>
                </div>

                <!-- Customer Analysis -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Müşteri Analizi</h2>
                    </div>
                    <div id="customerAnalysis">
                        <!-- Customer analysis will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h2 class="card-title">Rapor Dışa Aktarma</h2>
                </div>
                <div style="padding: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button id="exportSales" class="btn btn-outline">
                        <i class="fas fa-file-excel"></i>
                        Satış Raporu (CSV)
                    </button>
                    <button id="exportProducts" class="btn btn-outline">
                        <i class="fas fa-file-csv"></i>
                        Ürün Raporu (CSV)
                    </button>
                    <button id="exportCustomers" class="btn btn-outline">
                        <i class="fas fa-file-pdf"></i>
                        Müşteri Raporu (CSV)
                    </button>
                    <button id="printReport" class="btn btn-primary">
                        <i class="fas fa-print"></i>
                        Raporu Yazdır
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/main.js"></script>
    <script>
        class ReportManager {
            constructor() {
                this.data = null;
                this.currentPeriod = 'month';
                this.init();
            }

            init() {
                this.loadData();
                this.bindEvents();
                this.generateReports();
            }

            loadData() {
                this.data = JSON.parse(localStorage.getItem('firinData'));
                if (!this.data) {
                    this.data = { orders: [], products: {}, customers: [] };
                }
            }

            bindEvents() {
                document.getElementById('reportPeriod').addEventListener('change', (e) => {
                    this.currentPeriod = e.target.value;
                    this.generateReports();
                });

                document.getElementById('refreshReports').addEventListener('click', () => {
                    this.loadData();
                    this.generateReports();
                    this.showNotification('Raporlar yenilendi!', 'success');
                });

                // Export buttons
                document.getElementById('exportSales').addEventListener('click', () => {
                    this.exportSalesReport();
                });

                document.getElementById('exportProducts').addEventListener('click', () => {
                    this.exportProductsReport();
                });

                document.getElementById('exportCustomers').addEventListener('click', () => {
                    this.exportCustomersReport();
                });

                document.getElementById('printReport').addEventListener('click', () => {
                    window.print();
                });
            }

            generateReports() {
                const filteredOrders = this.getFilteredOrders();
                this.updateOverviewStats(filteredOrders);
                this.generateBestSellingProducts(filteredOrders);
                this.generateRevenueByCategory(filteredOrders);
                this.generateSalesChart(filteredOrders);
                this.generateStockReport();
                this.generateCustomerAnalysis();
            }

            getFilteredOrders() {
                const now = new Date();
                let startDate;

                switch (this.currentPeriod) {
                    case 'today':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'week':
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'year':
                        startDate = new Date(now.getFullYear(), 0, 1);
                        break;
                    default:
                        startDate = new Date(0);
                }

                return this.data.orders.filter(order => 
                    new Date(order.date) >= startDate && order.status !== 'cancelled'
                );
            }

            updateOverviewStats(orders) {
                const totalRevenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
                const totalOrders = orders.length;
                const averageOrder = totalOrders > 0 ? totalRevenue / totalOrders : 0;
                const totalProductsSold = orders.reduce((sum, order) => {
                    return sum + (order.items ? order.items.reduce((itemSum, item) => itemSum + item.quantity, 0) : 0);
                }, 0);

                document.getElementById('period-revenue').textContent = `${totalRevenue.toFixed(2)} TL`;
                document.getElementById('period-orders').textContent = totalOrders;
                document.getElementById('average-order').textContent = `${averageOrder.toFixed(2)} TL`;
                document.getElementById('total-products-sold').textContent = totalProductsSold;
            }

            generateBestSellingProducts(orders) {
                const productCounts = {};
                
                orders.forEach(order => {
                    if (order.items) {
                        order.items.forEach(item => {
                            if (!productCounts[item.name]) {
                                productCounts[item.name] = {
                                    name: item.name,
                                    quantity: 0,
                                    revenue: 0
                                };
                            }
                            productCounts[item.name].quantity += item.quantity;
                            productCounts[item.name].revenue += item.price * item.quantity;
                        });
                    }
                });

                const sortedProducts = Object.values(productCounts)
                    .sort((a, b) => b.quantity - a.quantity)
                    .slice(0, 5);

                const container = document.getElementById('bestSellingProducts');
                if (sortedProducts.length === 0) {
                    container.innerHTML = '<p>Bu dönemde satış bulunmuyor.</p>';
                    return;
                }

                container.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ürün</th>
                                <th>Satış Adedi</th>
                                <th>Gelir</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedProducts.map((product, index) => `
                                <tr>
                                    <td>
                                        <span style="color: var(--secondary-gold); margin-right: 0.5rem;">#${index + 1}</span>
                                        ${product.name}
                                    </td>
                                    <td>${product.quantity}</td>
                                    <td>${product.revenue.toFixed(2)} TL</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            generateRevenueByCategory(orders) {
                const categoryRevenue = { ekmek: 0, simit: 0, pasta: 0 };
                
                orders.forEach(order => {
                    if (order.items) {
                        order.items.forEach(item => {
                            // Simple category detection based on product name
                            const name = item.name.toLowerCase();
                            if (name.includes('ekmek') || name.includes('bread')) {
                                categoryRevenue.ekmek += item.price * item.quantity;
                            } else if (name.includes('simit')) {
                                categoryRevenue.simit += item.price * item.quantity;
                            } else if (name.includes('pasta') || name.includes('cake')) {
                                categoryRevenue.pasta += item.price * item.quantity;
                            }
                        });
                    }
                });

                const total = Object.values(categoryRevenue).reduce((sum, value) => sum + value, 0);
                const container = document.getElementById('revenueByCategory');

                if (total === 0) {
                    container.innerHTML = '<p>Bu dönemde gelir bulunmuyor.</p>';
                    return;
                }

                container.innerHTML = `
                    <div class="category-revenue">
                        ${Object.entries(categoryRevenue).map(([category, revenue]) => {
                            const percentage = total > 0 ? (revenue / total * 100).toFixed(1) : 0;
                            const categoryName = {
                                'ekmek': 'Ekmek',
                                'simit': 'Simit', 
                                'pasta': 'Pasta'
                            }[category];
                            
                            return `
                                <div style="margin: 1rem 0; padding: 1rem; background: var(--light-cream); border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <strong>${categoryName}</strong>
                                        <span>${revenue.toFixed(2)} TL</span>
                                    </div>
                                    <div style="background: #e9ecef; height: 10px; border-radius: 5px; overflow: hidden;">
                                        <div style="background: var(--secondary-gold); height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                                    </div>
                                    <small style="color: var(--text-dark); opacity: 0.7;">${percentage}% of total</small>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            generateSalesChart(orders) {
                const container = document.querySelector('#salesChart .chart-container');
                
                // Group orders by day for the last 7 days
                const last7Days = [];
                const now = new Date();
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(now.getTime() - i * 24 * 60 * 60 * 1000);
                    const dayOrders = orders.filter(order => {
                        const orderDate = new Date(order.date);
                        return orderDate.toDateString() === date.toDateString();
                    });
                    
                    const dayRevenue = dayOrders.reduce((sum, order) => sum + (order.total || 0), 0);
                    
                    last7Days.push({
                        date: date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' }),
                        revenue: dayRevenue,
                        orders: dayOrders.length
                    });
                }

                const maxRevenue = Math.max(...last7Days.map(day => day.revenue), 1);

                container.innerHTML = last7Days.map(day => {
                    const height = (day.revenue / maxRevenue) * 160; // Max height 160px
                    return `
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="
                                background: linear-gradient(to top, var(--secondary-gold), var(--accent-orange));
                                width: 30px;
                                height: ${height}px;
                                border-radius: 4px 4px 0 0;
                                margin-bottom: 0.5rem;
                                position: relative;
                                transition: all 0.3s ease;
                            " title="${day.revenue.toFixed(2)} TL - ${day.orders} sipariş"></div>
                            <small style="writing-mode: vertical-lr; text-orientation: mixed;">${day.date}</small>
                        </div>
                    `;
                }).join('');
            }

            generateStockReport() {
                const products = Object.values(this.data.products || {}).flat();
                const container = document.getElementById('stockReport');

                if (products.length === 0) {
                    container.innerHTML = '<p>Ürün bulunmuyor.</p>';
                    return;
                }

                const lowStockProducts = products.filter(p => p.stock < 10);
                const outOfStockProducts = products.filter(p => p.stock === 0);

                container.innerHTML = `
                    <div class="stock-summary" style="margin-bottom: 1rem;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
                            <div style="padding: 1rem; background: #d4edda; border-radius: 8px;">
                                <strong style="color: #155724;">${products.filter(p => p.stock > 10).length}</strong>
                                <div>Yeterli Stok</div>
                            </div>
                            <div style="padding: 1rem; background: #fff3cd; border-radius: 8px;">
                                <strong style="color: #856404;">${lowStockProducts.length}</strong>
                                <div>Düşük Stok</div>
                            </div>
                            <div style="padding: 1rem; background: #f8d7da; border-radius: 8px;">
                                <strong style="color: #721c24;">${outOfStockProducts.length}</strong>
                                <div>Stokta Yok</div>
                            </div>
                        </div>
                    </div>
                    
                    ${lowStockProducts.length > 0 ? `
                        <h5>Düşük Stoklu Ürünler</h5>
                        <div style="margin-bottom: 1rem;">
                            ${lowStockProducts.map(product => `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #fff3cd; margin: 0.25rem 0; border-radius: 4px;">
                                    <span>${product.name}</span>
                                    <span style="color: #856404; font-weight: bold;">${product.stock} adet</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${outOfStockProducts.length > 0 ? `
                        <h5>Stokta Olmayan Ürünler</h5>
                        <div>
                            ${outOfStockProducts.map(product => `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f8d7da; margin: 0.25rem 0; border-radius: 4px;">
                                    <span>${product.name}</span>
                                    <span style="color: #721c24; font-weight: bold;">Stokta Yok</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
            }

            generateCustomerAnalysis() {
                const customers = this.data.customers || [];
                const orders = this.data.orders || [];
                const container = document.getElementById('customerAnalysis');

                const totalCustomers = customers.length;
                const activeCustomers = customers.filter(c => c.status === 'active').length;
                const vipCustomers = customers.filter(c => c.vip).length;
                
                // Calculate repeat customers (more than 1 order)
                const customerOrderCounts = {};
                orders.forEach(order => {
                    const key = order.customerName || order.customerPhone;
                    customerOrderCounts[key] = (customerOrderCounts[key] || 0) + 1;
                });
                const repeatCustomers = Object.values(customerOrderCounts).filter(count => count > 1).length;

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div style="text-align: center; padding: 1rem; background: var(--light-cream); border-radius: 8px;">
                            <strong style="font-size: 1.5rem; color: var(--primary-brown);">${totalCustomers}</strong>
                            <div>Toplam Müşteri</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--light-cream); border-radius: 8px;">
                            <strong style="font-size: 1.5rem; color: var(--secondary-gold);">${activeCustomers}</strong>
                            <div>Aktif Müşteri</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--light-cream); border-radius: 8px;">
                            <strong style="font-size: 1.5rem; color: var(--accent-orange);">${vipCustomers}</strong>
                            <div>VIP Müşteri</div>
                        </div>
                        <div style="text-align: center; padding: 1rem; background: var(--light-cream); border-radius: 8px;">
                            <strong style="font-size: 1.5rem; color: #28a745;">${repeatCustomers}</strong>
                            <div>Sadık Müşteri</div>
                        </div>
                    </div>
                    
                    <div>
                        <h5>Müşteri Segmentasyonu</h5>
                        <div style="margin-top: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; margin: 0.25rem 0;">
                                <span>Aktif Oran:</span>
                                <span>${totalCustomers > 0 ? ((activeCustomers / totalCustomers) * 100).toFixed(1) : 0}%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 0.25rem 0;">
                                <span>VIP Oran:</span>
                                <span>${totalCustomers > 0 ? ((vipCustomers / totalCustomers) * 100).toFixed(1) : 0}%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 0.25rem 0;">
                                <span>Sadakat Oranı:</span>
                                <span>${totalCustomers > 0 ? ((repeatCustomers / totalCustomers) * 100).toFixed(1) : 0}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            exportSalesReport() {
                const orders = this.getFilteredOrders();
                let csv = 'Sipariş ID,Müşteri,Tarih,Toplam,Durum\n';
                
                orders.forEach(order => {
                    csv += `${order.id},"${order.customerName}","${new Date(order.date).toLocaleDateString('tr-TR')}",${order.total},"${order.status}"\n`;
                });

                this.downloadCSV(csv, 'sales-report.csv');
            }

            exportProductsReport() {
                const products = Object.values(this.data.products || {}).flat();
                let csv = 'ID,Ürün Adı,Kategori,Fiyat,Stok\n';
                
                products.forEach(product => {
                    csv += `${product.id},"${product.name}","${product.category}",${product.price},${product.stock}\n`;
                });

                this.downloadCSV(csv, 'products-report.csv');
            }

            exportCustomersReport() {
                const customers = this.data.customers || [];
                let csv = 'ID,Ad Soyad,Telefon,Email,Toplam Sipariş,Toplam Harcama,Durum\n';
                
                customers.forEach(customer => {
                    csv += `${customer.id},"${customer.name}","${customer.phone}","${customer.email || ''}",${customer.totalOrders},${customer.totalSpent},"${customer.status}"\n`;
                });

                this.downloadCSV(csv, 'customers-report.csv');
            }

            downloadCSV(csv, filename) {
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showNotification(`${filename} başarıyla indirildi!`, 'success');
                }
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 1rem 2rem;
                    border-radius: 8px;
                    color: white;
                    font-weight: 600;
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                `;
                
                switch (type) {
                    case 'success':
                        notification.style.backgroundColor = '#28a745';
                        break;
                    case 'error':
                        notification.style.backgroundColor = '#dc3545';
                        break;
                    default:
                        notification.style.backgroundColor = '#17a2b8';
                }
                
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 3000);
            }
        }

        // Initialize report manager
        let reportManager;
        document.addEventListener('DOMContentLoaded', () => {
            reportManager = new ReportManager();
        });
    </script>
</body>
</html>